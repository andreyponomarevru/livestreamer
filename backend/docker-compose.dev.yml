version: "3.7"

services:
  api:
    build:
      dockerfile: ./docker/Dockerfile.dev
    restart: always
    volumes:
      # set the container timezone to the time zone of host machine
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
      # Recompile code on changes
      - ./api/src:/api/src
      - ./api/_unit-tests_:/api/_unit-tests_
      - ./api/tsconfig.json:/api/tsconfig.json
      - /api/node_modules
    # Publicly exposed ports
    ports:
      # Port for the app
      - 5000:8080
      # node.js process is listening for a debugging client on
      - 9230:9229
    # Ports not exposed publicly i.e. to host machine
    # (they are only exposed to other services)
    expose:
      # Node.js application server
      - 5001
    env_file:
      - ./api/docker/.common.env
      - ./api/docker/.dev.env
      - ./postgres/docker/.common.env
      - ./postgres/docker/.dev.env
    depends_on:
      - devdb
      - redis
    networks:
      - frontend_livestreamer

  devdb:
    container_name: devdb
    build:
      context: ./postgres
      dockerfile: ./docker/Dockerfile
    restart: "no"
    env_file:
      - ./postgres/docker/.common.env
      - ./postgres/docker/.dev.env
    ports:
      - 54324:5432
    # volumes:
      # - ./postgres/init.sh:/docker-entrypoint-initdb.d/init.sh
      # Files used by init.sh script
      #- ./postgres/schema:/schema
      #- ./postgres/seeds:/seeds
    networks:
      - frontend_livestreamer

  redis:
    container_name: redis
    networks:
      - frontend_livestreamer      
      
networks:
  frontend_livestreamer:
    external: true
